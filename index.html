<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Market Sector Analysis Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>
    <header>
        <h1>Stock Market Sector Analysis Dashboard</h1>
        <p>Exploring sector performance, company comparisons, and market trends</p>
    </header>

    <main>
        <!-- Project Introduction -->
        <section class="intro-section">
            <h2>Project Introduction</h2>
            <p>
                This dashboard provides a comprehensive analysis of stock market performance across multiple sectors 
                from 2019 to 2025. The project aims to explore how different economic sectors respond to market 
                conditions, major events, and economic cycles. By examining normalized price indexes, return-volatility 
                relationships, sector correlations, and temporal trends, we can gain insights into sector behavior 
                and identify patterns that may inform investment strategies.
            </p>
            <p>
                The analysis focuses on four key sectors: Technology, Energy, Finance, and Healthcare, with two 
                representative companies from each sector. This selection allows for meaningful comparisons while 
                maintaining a manageable dataset for detailed exploration.
            </p>
        </section>

        <!-- Data Introduction -->
        <section class="intro-section">
            <h2>Data Introduction</h2>
            <p>
                The dataset consists of daily stock price data for eight major companies across four sectors:
            </p>
            <ul>
                <li><strong>Technology:</strong> Apple Inc. (AAPL) and Microsoft Corporation (MSFT)</li>
                <li><strong>Energy:</strong> Exxon Mobil Corporation (XOM) and Chevron Corporation (CVX)</li>
                <li><strong>Finance:</strong> JPMorgan Chase & Co. (JPM) and Bank of America Corporation (BAC)</li>
                <li><strong>Healthcare:</strong> UnitedHealth Group Inc. (UNH) and Pfizer Inc. (PFE)</li>
            </ul>
            <p>
                The data spans from January 1, 2019 to December 1, 2025, capturing significant market events including 
                the COVID-19 pandemic, market crashes, and economic recessions. For each company, we track:
            </p>
            <ul>
                <li><strong>Adjusted Closing Prices:</strong> Stock prices adjusted for splits and dividends</li>
                <li><strong>Trading Volume:</strong> Number of shares traded daily</li>
                <li><strong>Daily Returns:</strong> Percentage change in price from day to day</li>
                <li><strong>Volatility:</strong> Standard deviation of returns over rolling windows</li>
            </ul>
            <p>
                Sector-level aggregations are computed as equal-weighted averages of constituent companies, providing 
                a representative view of sector performance. All visualizations use normalized indexes starting at 100 
                to facilitate cross-sector comparisons.
            </p>
        </section>

        <div class="tabs">
            <button class="tab-link active" onclick="openTab(event, 'time-series')">Time Series Analysis</button>
            <button class="tab-link" onclick="openTab(event, 'risk-return')">Risk-Return Analysis</button>
            <button class="tab-link" onclick="openTab(event, 'sector-comparison')">Sector Comparison</button>
        </div>

        <!-- Time Series Analysis -->
        <div id="time-series" class="tab-content active">
            <section class="figure-block">
                <h2>Normalized Sector Price Indexes Over Time</h2>
                <iframe src="fig_altair_normalized_prices.html" width="100%" height="450" frameborder="0" style="border: 1px solid #ddd;"></iframe>
                <div class="interpretation">
                    <p><strong>Interpretation:</strong> This visualization shows how different sectors have performed over time, 
                    normalized to a starting value of 100. The vertical dashed lines highlight major market events: 
                    the COVID-19 pandemic declaration (March 2020), the market crash that followed, and the 2022 recession. 
                    We can observe that all sectors experienced significant declines during the COVID-19 crash, with Technology 
                    and Healthcare showing strong recovery patterns. Energy sectors show more volatility, particularly during 
                    the 2022 period. This chart helps identify which sectors are more resilient to economic shocks and which 
                    recover faster.</p>
                </div>
            </section>

            <section class="figure-block">
                <h2>Time-Slider: Trading Volume and Price Trends</h2>
                <p class="instructions">Use the year slider to explore trends over the years. Hover over the chart to see detailed information for each company.</p>
                <div id="d3-timeslider"></div>
                <div id="slider-container">
                    <label>Year: <span id="year-display">2019</span></label>
                    <input type="range" id="year-slider" min="2019" max="2024" value="2019" step="1">
                </div>
                <div class="interpretation">
                    <p><strong>Interpretation:</strong> This interactive visualization allows you to explore price and volume 
                    trends for individual companies by year. The top half shows adjusted closing prices, while the bottom half 
                    displays trading volume. Use the year slider to focus on specific periods. Higher trading volumes often 
                    coincide with significant price movements, indicating periods of high market activity. This helps identify 
                    which companies and sectors experienced the most trading activity during different market conditions, 
                    connecting to the broader sector trends shown in the normalized price chart above.</p>
                </div>
            </section>
        </div>

        <!-- Risk-Return Analysis -->
        <div id="risk-return" class="tab-content">
            <section class="figure-block">
                <h2>Average Return vs Volatility by Company</h2>
                <iframe src="fig_altair_return_volatility.html" width="100%" height="700" frameborder="0" style="border: 1px solid #ddd;"></iframe>
                <div class="interpretation">
                    <p><strong>Interpretation:</strong> This visualization combines two related views of risk-return relationships. 
                    The top chart shows monthly return trends, allowing you to see how returns fluctuate over time for different 
                    sectors. The bottom scatter plot displays the classic risk-return tradeoff, where each point represents a company. 
                    Companies in the upper-left quadrant offer high returns with low volatility (ideal), while those in the 
                    lower-right have high volatility with low returns (less desirable). Click on sectors in the legend to filter 
                    and compare. Click on individual points to highlight them. This analysis reveals which sectors and companies 
                    provide better risk-adjusted returns, connecting to the sector performance patterns observed in the time series.</p>
                </div>
            </section>

            <section class="figure-block">
                <h2>Interactive Company Dashboard</h2>
                <p class="instructions">Hover over companies to see detailed information. Use the legend to filter by sector.</p>
                <div id="d3-scatter"></div>
                <div id="tooltip"></div>
                <div class="interpretation">
                    <p><strong>Interpretation:</strong> This interactive scatter plot provides a detailed view of the risk-return 
                    profile for each company. The crosshair lines help you precisely read values when hovering. Companies are 
                    color-coded by sector, making it easy to identify sector-level patterns. Notice how companies within the same 
                    sector tend to cluster together, indicating similar risk-return characteristics. This visualization complements 
                    the monthly trend analysis above by providing an aggregate view of each company's overall performance, helping 
                    to identify outliers and sector-specific patterns.</p>
                </div>
            </section>
        </div>

        <!-- Sector Comparison -->
        <div id="sector-comparison" class="tab-content">
            <section class="figure-block">
                <h2>Sector Return Correlations</h2>
                <iframe src="fig_altair_correlation_heatmap.html" width="100%" height="650" frameborder="0" style="border: 1px solid #ddd;"></iframe>
                <div class="interpretation">
                    <p><strong>Interpretation:</strong> This heatmap shows correlation coefficients between sector daily returns, where 
                    values closer to 1 indicate sectors that move together, and values closer to -1 indicate inverse relationships. 
                    High correlations between sectors (especially during crises) suggest systemic risks that affect all sectors, while 
                    low correlations indicate diversification opportunities. This analysis connects to the time series visualization by 
                    explaining why sectors moved together during major events like COVID-19.</p>
                </div>
            </section>

        </div>

        <!-- Conclusion -->
        <section class="conclusion-section">
            <h2>Conclusion</h2>
            <p>
                This comprehensive analysis of stock market sector performance reveals several key insights:
            </p>
            <h3>Time Series Patterns</h3>
            <p>
                The normalized price index visualization demonstrates that all sectors experienced significant declines during 
                the COVID-19 pandemic, but recovery patterns varied. Technology and Healthcare sectors showed strong resilience 
                and rapid recovery, while Energy sectors exhibited higher volatility throughout the period. The 2022 recession 
                affected sectors differently, with some showing more pronounced impacts than others.
            </p>
            <h3>Risk-Return Relationships</h3>
            <p>
                The risk-return analysis reveals that sector characteristics are consistent: companies within the same sector 
                tend to cluster in similar risk-return spaces. Technology companies generally offer higher returns but with 
                moderate volatility, while Energy companies show higher volatility with variable returns. The monthly trend 
                analysis shows that these relationships are not static but evolve over time, with periods of convergence and 
                divergence between sectors.
            </p>
            <h3>Sector Interdependencies</h3>
            <p>
                The correlation analysis shows that sectors are generally positively correlated, especially during market crises, 
                indicating systemic risks that affect all sectors. However, correlation strength varies, with some sector pairs 
                showing stronger relationships than others. The volatility distribution analysis reveals that sector volatility 
                patterns have changed over time, with increased volatility during crisis periods affecting all sectors but to 
                varying degrees.
            </p>
            <h3>Practical Implications</h3>
            <p>
                These findings suggest that while diversification across sectors provides some protection, complete risk 
                mitigation is challenging during systemic events. Investors should consider both sector-level characteristics 
                and individual company performance when constructing portfolios. The varying recovery patterns and volatility 
                characteristics suggest that sector rotation strategies may be effective, particularly during economic transitions.
            </p>
            <p>
                Future research could extend this analysis to include more companies per sector, additional sectors, and 
                incorporate macroeconomic indicators to better understand the drivers of sector performance differences.
            </p>
        </section>
    </main>

    <script>
        function openTab(evt, tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-link').forEach(link => link.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            evt.currentTarget.classList.add('active');
        }

        let selectedSectors = new Set();
        
        function setupBrushAndLink() {
        }

        async function createD3Scatterplot() {
            const data = await d3.json('company_summary.json');
            const margin = {top: 30, right: 150, bottom: 80, left: 80};
            const width = 800 - margin.left - margin.right;
            const height = 500 - margin.top - margin.bottom;

            const svg = d3.select('#d3-scatter')
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .attr('viewBox', `0 0 ${width + margin.left + margin.right} ${height + margin.top + margin.bottom}`)
                .style('max-width', '100%')
                .style('height', 'auto')
                .attr('preserveAspectRatio', 'xMidYMid meet');

            const g = svg.append('g').attr('transform', `translate(${margin.left},${margin.top})`);

            const xScale = d3.scaleLinear()
                .domain(d3.extent(data, d => d.volatility_pct))
                .range([0, width])
                .nice();

            const yScale = d3.scaleLinear()
                .domain(d3.extent(data, d => d.avg_return_pct))
                .range([height, 0])
                .nice();

            const sectors = [...new Set(data.map(d => d.sector))];
            const colorScale = d3.scaleOrdinal().domain(sectors).range(d3.schemeCategory10);
            const tooltip = d3.select('#tooltip');

            // Add gridlines
            g.append('g')
                .attr('class', 'grid')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(xScale).tickSize(-height).tickFormat(''));
            
            g.append('g')
                .attr('class', 'grid')
                .call(d3.axisLeft(yScale).tickSize(-width).tickFormat(''));

            // Add axes with formatting
            const xAxis = d3.axisBottom(xScale).tickFormat(d => d.toFixed(2) + '%');
            const yAxis = d3.axisLeft(yScale).tickFormat(d => d.toFixed(2) + '%');

            g.append('g')
                .attr('transform', `translate(0,${height})`)
                .call(xAxis)
                .selectAll('text')
                .style('text-anchor', 'middle');

            g.append('g')
                .call(yAxis);

            // Add axis labels
            g.append('text')
                .attr('transform', `translate(${width / 2}, ${height + 50})`)
                .style('text-anchor', 'middle')
                .style('font-size', '14px')
                .style('font-weight', 'bold')
                .text('Volatility (Daily Standard Deviation %)');

            g.append('text')
                .attr('transform', 'rotate(-90)')
                .attr('y', -50)
                .attr('x', -height / 2)
                .style('text-anchor', 'middle')
                .style('font-size', '14px')
                .style('font-weight', 'bold')
                .text('Average Daily Return (%)');

            // Add crosshair lines (initially hidden)
            const crosshairX = g.append('line')
                .attr('class', 'crosshair')
                .attr('stroke', '#666')
                .attr('stroke-width', 1)
                .attr('stroke-dasharray', '3,3')
                .attr('opacity', 0);

            const crosshairY = g.append('line')
                .attr('class', 'crosshair')
                .attr('stroke', '#666')
                .attr('stroke-width', 1)
                .attr('stroke-dasharray', '3,3')
                .attr('opacity', 0);

            // Add circles with improved rendering
            const circles = g.selectAll('circle')
                .data(data)
                .enter()
                .append('circle')
                .attr('cx', d => xScale(d.volatility_pct))
                .attr('cy', d => yScale(d.avg_return_pct))
                .attr('r', 8)
                .attr('fill', d => colorScale(d.sector))
                .attr('opacity', 0.7)
                .attr('stroke', 'white')
                .attr('stroke-width', 2)
                .style('cursor', 'pointer')
                .style('shape-rendering', 'geometricPrecision')
                .on('mouseover', function(event, d) {
                    d3.select(this).attr('r', 14).attr('opacity', 1).attr('stroke-width', 3);
                    
                    // Show crosshairs
                    const xPos = xScale(d.volatility_pct);
                    const yPos = yScale(d.avg_return_pct);
                    crosshairX.attr('x1', xPos).attr('x2', xPos).attr('y1', 0).attr('y2', height).attr('opacity', 0.5);
                    crosshairY.attr('x1', 0).attr('x2', width).attr('y1', yPos).attr('y2', yPos).attr('opacity', 0.5);
                    
                    // Enhanced tooltip
                    tooltip.style('opacity', 1)
                        .html(`
                            <div style="font-weight: bold; font-size: 16px; margin-bottom: 8px; color: ${colorScale(d.sector)};">
                                ${d.Ticker}
                            </div>
                            <div style="margin-bottom: 5px;"><strong>Sector:</strong> ${d.sector}</div>
                            <div style="margin-bottom: 5px;"><strong>Avg Return:</strong> ${d.avg_return_pct.toFixed(3)}%</div>
                            <div style="margin-bottom: 5px;"><strong>Volatility:</strong> ${d.volatility_pct.toFixed(3)}%</div>
                            <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.3); font-size: 11px; color: #ccc;">
                                Risk-Return Profile
                            </div>
                        `)
                        .style('left', (event.pageX + 15) + 'px')
                        .style('top', (event.pageY - 10) + 'px');
                })
                .on('mousemove', function(event) {
                    tooltip.style('left', (event.pageX + 15) + 'px').style('top', (event.pageY - 10) + 'px');
                })
                .on('mouseout', function() {
                    d3.select(this).attr('r', 8).attr('opacity', 0.7).attr('stroke-width', 2);
                    crosshairX.attr('opacity', 0);
                    crosshairY.attr('opacity', 0);
                    tooltip.style('opacity', 0);
                });

            // Add ticker labels
            const labels = g.selectAll('text.label')
                .data(data)
                .enter()
                .append('text')
                .attr('x', d => xScale(d.volatility_pct))
                .attr('y', d => yScale(d.avg_return_pct) - 15)
                .attr('text-anchor', 'middle')
                .attr('font-size', '11px')
                .attr('fill', '#333')
                .attr('font-weight', '500')
                .text(d => d.Ticker);

            // Add legend with clickable filtering
            const legend = g.append('g').attr('transform', `translate(${width + 20}, 20)`);
            let selectedSectorsScatter = new Set(sectors);
            
            const legendItems = legend.selectAll('.legend-item')
                .data(sectors)
                .enter()
                .append('g')
                .attr('class', 'legend-item')
                .attr('transform', (d, i) => `translate(0, ${i * 25})`)
                .style('cursor', 'pointer')
                .on('click', function(event, d) {
                    if (selectedSectorsScatter.has(d)) {
                        selectedSectorsScatter.delete(d);
                        d3.select(this).select('rect').attr('opacity', 0.3);
                    } else {
                        selectedSectorsScatter.add(d);
                        d3.select(this).select('rect').attr('opacity', 1);
                    }
                    updateFilteredScatter();
                });

            legendItems.append('rect')
                .attr('width', 18)
                .attr('height', 18)
                .attr('fill', d => colorScale(d))
                .attr('rx', 3)
                .attr('opacity', 1);

            legendItems.append('text')
                .attr('x', 25)
                .attr('y', 14)
                .attr('font-size', '12px')
                .attr('fill', '#333')
                .text(d => d);
            
            function updateFilteredScatter() {
                circles
                    .attr('opacity', d => selectedSectorsScatter.has(d.sector) ? 0.7 : 0.1)
                    .attr('pointer-events', d => selectedSectorsScatter.has(d.sector) ? 'all' : 'none');
                
                labels
                    .attr('opacity', d => selectedSectorsScatter.has(d.sector) ? 1 : 0.1);
            }
        }

        async function createD3TimeSlider() {
            const data = await d3.json('time_series_data.json');
            data.forEach(d => {
                d.date = new Date(d.date);
                d.adj_close = +d.adj_close;
                d.volume = +d.volume;
            });

            const margin = {top: 30, right: 150, bottom: 80, left: 80};
            const width = 900 - margin.left - margin.right;
            const height = 500 - margin.top - margin.bottom;

            const svg = d3.select('#d3-timeslider')
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .attr('viewBox', `0 0 ${width + margin.left + margin.right} ${height + margin.top + margin.bottom}`)
                .style('max-width', '100%')
                .style('height', 'auto')
                .attr('preserveAspectRatio', 'xMidYMid meet');

            const g = svg.append('g').attr('transform', `translate(${margin.left},${margin.top})`);

            const sectors = [...new Set(data.map(d => d.sector))];
            const colorScale = d3.scaleOrdinal().domain(sectors).range(d3.schemeCategory10);
            const tooltip = d3.select('#tooltip');

            let xScale = d3.scaleTime().range([0, width]);
            let yPriceScale = d3.scaleLinear().range([height / 2, 0]);
            let yVolumeScale = d3.scaleLinear().range([height, height / 2]);

            // Divider line
            g.append('line').attr('x1', 0).attr('x2', width).attr('y1', height / 2).attr('y2', height / 2)
                .attr('stroke', '#999').attr('stroke-width', 2).attr('stroke-dasharray', '5,5');

            // Format functions
            const formatPrice = d3.format('$.2f');
            const formatVolume = d => (d / 1e6).toFixed(1) + 'M';
            const formatDate = d3.timeFormat('%b %d, %Y');

            const priceLine = d3.line()
                .x(d => xScale(d.date))
                .y(d => yPriceScale(d.adj_close))
                .curve(d3.curveMonotoneX);

            const volumeLine = d3.line()
                .x(d => xScale(d.date))
                .y(d => yVolumeScale(d.volume))
                .curve(d3.curveMonotoneX);

            // Invisible overlay for mouse tracking
            const overlay = g.append('rect')
                .attr('width', width)
                .attr('height', height)
                .attr('fill', 'none')
                .attr('pointer-events', 'all')
                .style('cursor', 'crosshair');

            // Vertical line for hover
            const hoverLine = g.append('line')
                .attr('class', 'hover-line')
                .attr('stroke', '#666')
                .attr('stroke-width', 1)
                .attr('stroke-dasharray', '3,3')
                .attr('opacity', 0);

            function updateChart(year) {
                const filteredData = data.filter(d => d.date.getFullYear() === year);
                
                // Remove old chart elements
                g.selectAll('.price-line, .volume-line, .price-point, .volume-point, .grid, .x-axis, .y-price-axis, .y-volume-axis, .axis-label, .no-data-message').remove();
                
                if (filteredData.length > 0) {
                    // Update scales based on filtered data
                    xScale.domain(d3.extent(filteredData, d => d.date));
                    yPriceScale.domain(d3.extent(filteredData, d => d.adj_close)).nice();
                    yVolumeScale.domain(d3.extent(filteredData, d => d.volume)).nice();
                    
                    // Update gridlines with new scales
                    const xAxisGrid = d3.axisBottom(xScale).tickSize(-height / 2).tickFormat('');
                    const yPriceAxisGrid = d3.axisLeft(yPriceScale).tickSize(-width).tickFormat('');
                    const yVolumeAxisGrid = d3.axisRight(yVolumeScale).tickSize(-width).tickFormat('');
                    
                    g.append('g').attr('class', 'grid').attr('transform', `translate(0,${height / 2})`).call(xAxisGrid);
                    g.append('g').attr('class', 'grid').call(yPriceAxisGrid);
                    g.append('g').attr('class', 'grid').attr('transform', `translate(${width}, 0)`).call(yVolumeAxisGrid);
                    
                    // Update axes
                    const xAxis = d3.axisBottom(xScale)
                        .ticks(d3.timeMonth.every(1))
                        .tickFormat(d3.timeFormat('%b'));
                    g.append('g').attr('class', 'x-axis').attr('transform', `translate(0,${height / 2})`).call(xAxis)
                        .selectAll('text').style('text-anchor', 'middle').style('font-size', '11px');
                    
                    const yPriceAxis = d3.axisLeft(yPriceScale).tickFormat(formatPrice);
                    g.append('g').attr('class', 'y-price-axis').call(yPriceAxis)
                        .selectAll('text').style('font-size', '11px');
                    
                    const yVolumeAxis = d3.axisRight(yVolumeScale).tickFormat(formatVolume);
                    g.append('g').attr('class', 'y-volume-axis').attr('transform', `translate(${width}, 0)`).call(yVolumeAxis)
                        .selectAll('text').style('font-size', '11px');

                    // Add axis labels
                    g.selectAll('.axis-label').remove();
                    // Date label 
                    g.append('text').attr('class', 'axis-label')
                        .attr('transform', `translate(${width / 2}, ${height / 2 + 35})`)
                        .style('text-anchor', 'middle').style('font-size', '14px').style('font-weight', 'bold')
                        .text('Date');
                    
                    // Price label (left Y-axis)
                    g.append('text').attr('class', 'axis-label')
                        .attr('transform', 'rotate(-90)').attr('y', -60).attr('x', -height / 4)
                        .style('text-anchor', 'middle').style('font-size', '14px').style('font-weight', 'bold')
                        .text('Price (USD)');
                    g.append('text').attr('class', 'axis-label')
                        .attr('transform', `translate(${width / 2}, ${height + 50})`)
                        .style('text-anchor', 'middle').style('font-size', '14px').style('font-weight', 'bold')
                        .text('Volume (Millions)');
                    g.selectAll('.price-line, .volume-line, .price-point, .volume-point').remove();
                    
                    // Group by ticker
                    const grouped = d3.group(filteredData, d => d.Ticker);
                    
                    grouped.forEach((values, ticker) => {
                        const sector = values[0].sector;
                        const color = colorScale(sector);
                        
                        // Price line
                        const pricePath = g.append('path')
                            .datum(values)
                            .attr('class', 'price-line')
                            .attr('fill', 'none')
                            .attr('stroke', color)
                            .attr('stroke-width', 2.5)
                            .attr('opacity', 0.8)
                            .attr('d', priceLine)
                            .style('cursor', 'pointer')
                            .style('shape-rendering', 'geometricPrecision')
                            .style('vector-effect', 'non-scaling-stroke');
                        
                        const volumePath = g.append('path')
                            .datum(values)
                            .attr('class', 'volume-line')
                            .attr('fill', 'none')
                            .attr('stroke', color)
                            .attr('stroke-width', 2)
                            .attr('stroke-dasharray', '4,4')
                            .attr('opacity', 0.6)
                            .attr('d', volumeLine)
                            .style('cursor', 'pointer')
                            .style('shape-rendering', 'geometricPrecision')
                            .style('vector-effect', 'non-scaling-stroke');
                        
                        // Add hover interactions
                        [pricePath, volumePath].forEach(path => {
                            path.on('mouseover', function() {
                                d3.select(this).attr('stroke-width', 3).attr('opacity', 1);
                            })
                            .on('mouseout', function() {
                                if (this.classList.contains('price-line')) {
                                    d3.select(this).attr('stroke-width', 2.5).attr('opacity', 0.8);
                                } else {
                                    d3.select(this).attr('stroke-width', 2).attr('opacity', 0.6);
                                }
                            });
                        });
                    });

                    // Mouse tracking on overlay
                    overlay.on('mousemove', function(event) {
                        const [mouseX] = d3.pointer(event, this);
                        const date = xScale.invert(mouseX);
                        
                        // Find closest date in data
                        let closestDate = null;
                        let minDist = Infinity;
                        filteredData.forEach(d => {
                            const dist = Math.abs(xScale(d.date) - mouseX);
                            if (dist < minDist) {
                                minDist = dist;
                                closestDate = d.date;
                            }
                        });
                        
                        if (closestDate && minDist < 30) {
                            // Get all data points for this date
                            const dateData = filteredData.filter(d => 
                                d.date.getTime() === closestDate.getTime()
                            );
                            
                            if (dateData.length > 0) {
                                hoverLine.attr('x1', mouseX).attr('x2', mouseX)
                                    .attr('y1', 0).attr('y2', height).attr('opacity', 0.6);
                                
                                // Group by sector and calculate statistics
                                const sectorGroups = d3.group(dateData, d => d.sector);
                                let tooltipContent = `
                                    <div style="font-weight: bold; font-size: 16px; margin-bottom: 10px; border-bottom: 2px solid #666; padding-bottom: 5px;">
                                        ${formatDate(closestDate)}
                                    </div>
                                `;
                                
                                sectors.forEach(sector => {
                                    if (sectorGroups.has(sector)) {
                                        const sectorData = sectorGroups.get(sector);
                                        const avgPrice = d3.mean(sectorData, d => d.adj_close);
                                        const totalVolume = d3.sum(sectorData, d => d.volume);
                                        const companies = sectorData.map(d => d.Ticker).join(', ');
                                        
                                        tooltipContent += `
                                            <div style="margin-bottom: 12px; padding: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; border-left: 4px solid ${colorScale(sector)};">
                                                <div style="font-weight: bold; font-size: 14px; color: ${colorScale(sector)}; margin-bottom: 5px;">
                                                    ${sector}
                                                </div>
                                                <div style="font-size: 12px; margin-bottom: 3px;">
                                                    <strong>Avg Price:</strong> ${formatPrice(avgPrice)}
                                                </div>
                                                <div style="font-size: 12px; margin-bottom: 3px;">
                                                    <strong>Total Volume:</strong> ${formatVolume(totalVolume)}
                                                </div>
                                                <div style="font-size: 11px; color: #ccc; margin-top: 5px;">
                                                    Companies: ${companies}
                                                </div>
                                            </div>
                                        `;
                                    }
                                });
                                
                                tooltip.style('opacity', 1)
                                    .html(tooltipContent)
                                    .style('left', (event.pageX + 15) + 'px')
                                    .style('top', (event.pageY - 10) + 'px')
                                    .style('max-width', '300px');
                            } else {
                                hoverLine.attr('opacity', 0);
                                tooltip.style('opacity', 0);
                            }
                        } else {
                            hoverLine.attr('opacity', 0);
                            tooltip.style('opacity', 0);
                        }
                    })
                    .on('mouseout', function() {
                        hoverLine.attr('opacity', 0);
                        tooltip.style('opacity', 0);
                    });
                } else {
                    g.append('text')
                        .attr('class', 'no-data-message')
                        .attr('x', width / 2)
                        .attr('y', height / 2)
                        .attr('text-anchor', 'middle')
                        .attr('font-size', '16px')
                        .attr('fill', '#999')
                        .text('No data available for selected year');
                }
            }

            // Add legend 
            const legend = g.append('g').attr('transform', `translate(${width + 20}, 20)`);
            
            const legendItems = legend.selectAll('.legend-item')
                .data(sectors)
                .enter()
                .append('g')
                .attr('class', 'legend-item')
                .attr('transform', (d, i) => `translate(0, ${i * 25})`);

            legendItems.append('rect')
                .attr('width', 18)
                .attr('height', 18)
                .attr('fill', d => colorScale(d))
                .attr('rx', 3);

            legendItems.append('text')
                .attr('x', 25)
                .attr('y', 14)
                .attr('font-size', '12px')
                .attr('fill', '#333')
                .text(d => d);

            document.getElementById('year-slider').addEventListener('input', function() {
                const year = +this.value;
                document.getElementById('year-display').textContent = year;
                updateChart(year);
            });

            updateChart(2019);
        }

        window.addEventListener('DOMContentLoaded', () => {
            createD3Scatterplot();
            createD3TimeSlider();
        });
    </script>
</body>
</html>
