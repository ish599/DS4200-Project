<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Market Sector Analysis Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>
    <header>
        <h1>Stock Market Sector Analysis Dashboard</h1>
        <p>Exploring sector performance, company comparisons, and market trends</p>
    </header>

    <main>
        <div class="tabs">
            <button class="tab-link active" onclick="openTab(event, 'static')">Static Visualizations</button>
            <button class="tab-link" onclick="openTab(event, 'interactive')">Interactive Visualizations</button>
        </div>

        <div id="static" class="tab-content active">
            <section class="figure-block">
                <h2>Normalized Sector Price Indexes Over Time</h2>
                <iframe src="fig_altair_normalized_prices.html" width="100%" height="400" frameborder="0" style="border: 1px solid #ddd;"></iframe>
            </section>

            <section class="figure-block">
                <h2>Average Return vs Volatility by Company</h2>
                <iframe src="fig_altair_return_volatility.html" width="100%" height="450" frameborder="0" style="border: 1px solid #ddd;"></iframe>
            </section>

            <section class="figure-block">
                <h2>Sector Return Correlations</h2>
                <iframe src="fig_altair_correlation_heatmap.html" width="100%" height="450" frameborder="0" style="border: 1px solid #ddd;"></iframe>
            </section>
        </div>

        <div id="interactive" class="tab-content">
            <section class="figure-block">
                <h2>Interactive Company Dashboard</h2>
                <p class="instructions">Hover over companies to see detailed information.</p>
                <div id="d3-scatter"></div>
                <div id="tooltip"></div>
            </section>

            <section class="figure-block">
                <h2>Time-Slider: Trading Volume and Price Trends</h2>
                <p class="instructions">Use the slider to explore trends over the years.</p>
                <div id="d3-timeslider"></div>
                <div id="slider-container">
                    <label>Year: <span id="year-display">2019</span></label>
                    <input type="range" id="year-slider" min="2019" max="2024" value="2019" step="1">
                </div>
            </section>
        </div>
    </main>

    <script>
        function openTab(evt, tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-link').forEach(link => link.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            evt.currentTarget.classList.add('active');
        }

        async function createD3Scatterplot() {
            const data = await d3.json('company_summary.json');
            const margin = {top: 30, right: 150, bottom: 80, left: 80};
            const width = 800 - margin.left - margin.right;
            const height = 500 - margin.top - margin.bottom;

            const svg = d3.select('#d3-scatter')
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom);

            const g = svg.append('g').attr('transform', `translate(${margin.left},${margin.top})`);

            const xScale = d3.scaleLinear()
                .domain(d3.extent(data, d => d.volatility_pct))
                .range([0, width])
                .nice();

            const yScale = d3.scaleLinear()
                .domain(d3.extent(data, d => d.avg_return_pct))
                .range([height, 0])
                .nice();

            const sectors = [...new Set(data.map(d => d.sector))];
            const colorScale = d3.scaleOrdinal().domain(sectors).range(d3.schemeCategory10);
            const tooltip = d3.select('#tooltip');

            // Add gridlines
            g.append('g')
                .attr('class', 'grid')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(xScale).tickSize(-height).tickFormat(''));
            
            g.append('g')
                .attr('class', 'grid')
                .call(d3.axisLeft(yScale).tickSize(-width).tickFormat(''));

            // Add axes with formatting
            const xAxis = d3.axisBottom(xScale).tickFormat(d => d.toFixed(2) + '%');
            const yAxis = d3.axisLeft(yScale).tickFormat(d => d.toFixed(2) + '%');

            g.append('g')
                .attr('transform', `translate(0,${height})`)
                .call(xAxis)
                .selectAll('text')
                .style('text-anchor', 'middle');

            g.append('g')
                .call(yAxis);

            // Add axis labels
            g.append('text')
                .attr('transform', `translate(${width / 2}, ${height + 50})`)
                .style('text-anchor', 'middle')
                .style('font-size', '14px')
                .style('font-weight', 'bold')
                .text('Volatility (Daily Standard Deviation %)');

            g.append('text')
                .attr('transform', 'rotate(-90)')
                .attr('y', -50)
                .attr('x', -height / 2)
                .style('text-anchor', 'middle')
                .style('font-size', '14px')
                .style('font-weight', 'bold')
                .text('Average Daily Return (%)');

            // Add crosshair lines (initially hidden)
            const crosshairX = g.append('line')
                .attr('class', 'crosshair')
                .attr('stroke', '#666')
                .attr('stroke-width', 1)
                .attr('stroke-dasharray', '3,3')
                .attr('opacity', 0);

            const crosshairY = g.append('line')
                .attr('class', 'crosshair')
                .attr('stroke', '#666')
                .attr('stroke-width', 1)
                .attr('stroke-dasharray', '3,3')
                .attr('opacity', 0);

            // Add circles
            const circles = g.selectAll('circle')
                .data(data)
                .enter()
                .append('circle')
                .attr('cx', d => xScale(d.volatility_pct))
                .attr('cy', d => yScale(d.avg_return_pct))
                .attr('r', 8)
                .attr('fill', d => colorScale(d.sector))
                .attr('opacity', 0.7)
                .attr('stroke', 'white')
                .attr('stroke-width', 2)
                .style('cursor', 'pointer')
                .on('mouseover', function(event, d) {
                    d3.select(this).attr('r', 14).attr('opacity', 1).attr('stroke-width', 3);
                    
                    // Show crosshairs
                    const xPos = xScale(d.volatility_pct);
                    const yPos = yScale(d.avg_return_pct);
                    crosshairX.attr('x1', xPos).attr('x2', xPos).attr('y1', 0).attr('y2', height).attr('opacity', 0.5);
                    crosshairY.attr('x1', 0).attr('x2', width).attr('y1', yPos).attr('y2', yPos).attr('opacity', 0.5);
                    
                    // Enhanced tooltip
                    tooltip.style('opacity', 1)
                        .html(`
                            <div style="font-weight: bold; font-size: 16px; margin-bottom: 8px; color: ${colorScale(d.sector)};">
                                ${d.Ticker}
                            </div>
                            <div style="margin-bottom: 5px;"><strong>Sector:</strong> ${d.sector}</div>
                            <div style="margin-bottom: 5px;"><strong>Avg Return:</strong> ${d.avg_return_pct.toFixed(3)}%</div>
                            <div style="margin-bottom: 5px;"><strong>Volatility:</strong> ${d.volatility_pct.toFixed(3)}%</div>
                            <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.3); font-size: 11px; color: #ccc;">
                                Risk-Return Profile
                            </div>
                        `)
                        .style('left', (event.pageX + 15) + 'px')
                        .style('top', (event.pageY - 10) + 'px');
                })
                .on('mousemove', function(event) {
                    tooltip.style('left', (event.pageX + 15) + 'px').style('top', (event.pageY - 10) + 'px');
                })
                .on('mouseout', function() {
                    d3.select(this).attr('r', 8).attr('opacity', 0.7).attr('stroke-width', 2);
                    crosshairX.attr('opacity', 0);
                    crosshairY.attr('opacity', 0);
                    tooltip.style('opacity', 0);
                });

            // Add ticker labels
            g.selectAll('text.label')
                .data(data)
                .enter()
                .append('text')
                .attr('x', d => xScale(d.volatility_pct))
                .attr('y', d => yScale(d.avg_return_pct) - 15)
                .attr('text-anchor', 'middle')
                .attr('font-size', '11px')
                .attr('fill', '#333')
                .attr('font-weight', '500')
                .text(d => d.Ticker);

            // Add legend
            const legend = g.append('g').attr('transform', `translate(${width + 20}, 20)`);
            const legendItems = legend.selectAll('.legend-item')
                .data(sectors)
                .enter()
                .append('g')
                .attr('class', 'legend-item')
                .attr('transform', (d, i) => `translate(0, ${i * 25})`);

            legendItems.append('rect')
                .attr('width', 18)
                .attr('height', 18)
                .attr('fill', d => colorScale(d))
                .attr('rx', 3);

            legendItems.append('text')
                .attr('x', 25)
                .attr('y', 14)
                .attr('font-size', '12px')
                .attr('fill', '#333')
                .text(d => d);
        }

        async function createD3TimeSlider() {
            const data = await d3.json('time_series_data.json');
            data.forEach(d => {
                d.date = new Date(d.date);
                d.adj_close = +d.adj_close;
                d.volume = +d.volume;
            });

            const margin = {top: 30, right: 150, bottom: 80, left: 80};
            const width = 900 - margin.left - margin.right;
            const height = 500 - margin.top - margin.bottom;

            const svg = d3.select('#d3-timeslider')
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom);

            const g = svg.append('g').attr('transform', `translate(${margin.left},${margin.top})`);

            const sectors = [...new Set(data.map(d => d.sector))];
            const colorScale = d3.scaleOrdinal().domain(sectors).range(d3.schemeCategory10);
            const tooltip = d3.select('#tooltip');

            let xScale = d3.scaleTime().range([0, width]);
            const yPriceScale = d3.scaleLinear().domain(d3.extent(data, d => d.adj_close)).range([height / 2, 0]).nice();
            const yVolumeScale = d3.scaleLinear().domain(d3.extent(data, d => d.volume)).range([height, height / 2]).nice();

            // Add gridlines
            const xAxisGrid = d3.axisBottom(xScale).tickSize(-height / 2).tickFormat('');
            const yPriceAxisGrid = d3.axisLeft(yPriceScale).tickSize(-width).tickFormat('');
            const yVolumeAxisGrid = d3.axisRight(yVolumeScale).tickSize(-width).tickFormat('');

            // Divider line
            g.append('line').attr('x1', 0).attr('x2', width).attr('y1', height / 2).attr('y2', height / 2)
                .attr('stroke', '#999').attr('stroke-width', 2).attr('stroke-dasharray', '5,5');

            // Format functions
            const formatPrice = d3.format('$.2f');
            const formatVolume = d => (d / 1e6).toFixed(1) + 'M';
            const formatDate = d3.timeFormat('%b %d, %Y');

            const priceLine = d3.line()
                .x(d => xScale(d.date))
                .y(d => yPriceScale(d.adj_close))
                .curve(d3.curveMonotoneX);

            const volumeLine = d3.line()
                .x(d => xScale(d.date))
                .y(d => yVolumeScale(d.volume))
                .curve(d3.curveMonotoneX);

            // Invisible overlay for mouse tracking
            const overlay = g.append('rect')
                .attr('width', width)
                .attr('height', height)
                .attr('fill', 'none')
                .attr('pointer-events', 'all')
                .style('cursor', 'crosshair');

            // Vertical line for hover
            const hoverLine = g.append('line')
                .attr('class', 'hover-line')
                .attr('stroke', '#666')
                .attr('stroke-width', 1)
                .attr('stroke-dasharray', '3,3')
                .attr('opacity', 0);

            function updateChart(year) {
                const filteredData = data.filter(d => d.date.getFullYear() === year);
                if (filteredData.length > 0) {
                    xScale.domain(d3.extent(filteredData, d => d.date));
                    
                    // Update gridlines
                    g.selectAll('.grid').remove();
                    g.append('g').attr('class', 'grid').attr('transform', `translate(0,${height / 2})`).call(xAxisGrid);
                    g.append('g').attr('class', 'grid').call(yPriceAxisGrid);
                    g.append('g').attr('class', 'grid').attr('transform', `translate(${width}, 0)`).call(yVolumeAxisGrid);
                    
                    // Update axes
                    g.selectAll('.x-axis, .y-price-axis, .y-volume-axis').remove();
                    
                    const xAxis = d3.axisBottom(xScale)
                        .ticks(d3.timeMonth.every(1))
                        .tickFormat(d3.timeFormat('%b'));
                    g.append('g').attr('class', 'x-axis').attr('transform', `translate(0,${height / 2})`).call(xAxis)
                        .selectAll('text').style('text-anchor', 'middle').style('font-size', '11px');
                    
                    const yPriceAxis = d3.axisLeft(yPriceScale).tickFormat(formatPrice);
                    g.append('g').attr('class', 'y-price-axis').call(yPriceAxis)
                        .selectAll('text').style('font-size', '11px');
                    
                    const yVolumeAxis = d3.axisRight(yVolumeScale).tickFormat(formatVolume);
                    g.append('g').attr('class', 'y-volume-axis').attr('transform', `translate(${width}, 0)`).call(yVolumeAxis)
                        .selectAll('text').style('font-size', '11px');

                    // Add axis labels
                    g.selectAll('.axis-label').remove();
                    // Date label - moved higher (reduced from 50 to 35)
                    g.append('text').attr('class', 'axis-label')
                        .attr('transform', `translate(${width / 2}, ${height / 2 + 35})`)
                        .style('text-anchor', 'middle').style('font-size', '14px').style('font-weight', 'bold')
                        .text('Date');
                    
                    // Price label (left Y-axis)
                    g.append('text').attr('class', 'axis-label')
                        .attr('transform', 'rotate(-90)').attr('y', -60).attr('x', -height / 4)
                        .style('text-anchor', 'middle').style('font-size', '14px').style('font-weight', 'bold')
                        .text('Price (USD)');
                    
                    // Volume label - moved to bottom of the chart (bottom graph area)
                    g.append('text').attr('class', 'axis-label')
                        .attr('transform', `translate(${width / 2}, ${height + 50})`)
                        .style('text-anchor', 'middle').style('font-size', '14px').style('font-weight', 'bold')
                        .text('Volume (Millions)');
                }

                // Remove old lines
                g.selectAll('.price-line, .volume-line, .price-point, .volume-point').remove();
                
                // Group by ticker
                const grouped = d3.group(filteredData, d => d.Ticker);
                
                grouped.forEach((values, ticker) => {
                    const sector = values[0].sector;
                    const color = colorScale(sector);
                    
                    // Price line
                    const pricePath = g.append('path')
                        .datum(values)
                        .attr('class', 'price-line')
                        .attr('fill', 'none')
                        .attr('stroke', color)
                        .attr('stroke-width', 2)
                        .attr('opacity', 0.8)
                        .attr('d', priceLine)
                        .style('cursor', 'pointer');
                    
                    // Volume line
                    const volumePath = g.append('path')
                        .datum(values)
                        .attr('class', 'volume-line')
                        .attr('fill', 'none')
                        .attr('stroke', color)
                        .attr('stroke-width', 1.5)
                        .attr('stroke-dasharray', '4,4')
                        .attr('opacity', 0.6)
                        .attr('d', volumeLine)
                        .style('cursor', 'pointer');
                    
                    // Add hover interactions
                    [pricePath, volumePath].forEach(path => {
                        path.on('mouseover', function() {
                            d3.select(this).attr('stroke-width', 3).attr('opacity', 1);
                        })
                        .on('mouseout', function() {
                            if (this.classList.contains('price-line')) {
                                d3.select(this).attr('stroke-width', 2).attr('opacity', 0.8);
                            } else {
                                d3.select(this).attr('stroke-width', 1.5).attr('opacity', 0.6);
                            }
                        });
                    });
                });

                // Mouse tracking on overlay
                overlay.on('mousemove', function(event) {
                    const [mouseX] = d3.pointer(event, this);
                    const date = xScale.invert(mouseX);
                    
                    // Find closest data point
                    let closest = null;
                    let minDist = Infinity;
                    filteredData.forEach(d => {
                        const dist = Math.abs(xScale(d.date) - mouseX);
                        if (dist < minDist) {
                            minDist = dist;
                            closest = d;
                        }
                    });
                    
                    if (closest && minDist < 20) {
                        hoverLine.attr('x1', mouseX).attr('x2', mouseX)
                            .attr('y1', 0).attr('y2', height).attr('opacity', 0.6);
                        
                        tooltip.style('opacity', 1)
                            .html(`
                                <div style="font-weight: bold; font-size: 14px; margin-bottom: 8px;">
                                    ${closest.Ticker} - ${formatDate(closest.date)}
                                </div>
                                <div style="margin-bottom: 5px; color: ${colorScale(closest.sector)};">
                                    <strong>Sector:</strong> ${closest.sector}
                                </div>
                                <div style="margin-bottom: 5px;">
                                    <strong>Price:</strong> ${formatPrice(closest.adj_close)}
                                </div>
                                <div style="margin-bottom: 5px;">
                                    <strong>Volume:</strong> ${formatVolume(closest.volume)}
                                </div>
                            `)
                            .style('left', (event.pageX + 15) + 'px')
                            .style('top', (event.pageY - 10) + 'px');
                    } else {
                        hoverLine.attr('opacity', 0);
                        tooltip.style('opacity', 0);
                    }
                })
                .on('mouseout', function() {
                    hoverLine.attr('opacity', 0);
                    tooltip.style('opacity', 0);
                });
            }

            // Add legend
            const legend = g.append('g').attr('transform', `translate(${width + 20}, 20)`);
            const legendItems = legend.selectAll('.legend-item')
                .data(sectors)
                .enter()
                .append('g')
                .attr('class', 'legend-item')
                .attr('transform', (d, i) => `translate(0, ${i * 25})`);

            legendItems.append('rect')
                .attr('width', 18)
                .attr('height', 18)
                .attr('fill', d => colorScale(d))
                .attr('rx', 3);

            legendItems.append('text')
                .attr('x', 25)
                .attr('y', 14)
                .attr('font-size', '12px')
                .attr('fill', '#333')
                .text(d => d);

            document.getElementById('year-slider').addEventListener('input', function() {
                const year = +this.value;
                document.getElementById('year-display').textContent = year;
                updateChart(year);
            });

            updateChart(2019);
        }

        window.addEventListener('DOMContentLoaded', () => {
            createD3Scatterplot();
            createD3TimeSlider();
        });
    </script>
</body>
</html>
